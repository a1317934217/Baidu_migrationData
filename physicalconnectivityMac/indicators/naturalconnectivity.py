# -*- coding: utf-8 -*-
import datetime
from math import e
from math import log

import networkx as nx
import numpy as np
import pandas as pd
# coding=utf-8
from matplotlib import pyplot as plt
from matplotlib.font_manager import FontProperties
from matplotlib.ticker import FuncFormatter, MaxNLocator

listDelCtiyName = ['昌吉回族自治州', '万宁', '昌都地区', '克拉玛依', '吉林市', '海口', '临高', '东方', '宁夏回族自治区', '莱芜', '果洛藏族自治州', '石嘴山', '阿拉善盟', '神农架林区', '五家渠', '三亚', '吴忠', '内蒙古自治区', '定安', '北屯', '白沙黎族自治县', '乌鲁木齐', '拉萨', '阿里地区', '香港', '昌江黎族自治县', '广西壮族自治区', '阿拉尔', '阿克苏地区', '日喀则地区', '甘南藏族自治州', '保亭黎族苗族自治县', '酒泉', '山南地区', '琼海', '海东地区', '可克达拉', '黄南藏族自治州', '图木舒克', '固原', '阿勒泰地区', '西藏自治区', '双河', '澳门', '中卫', '文昌', '迪庆藏族自治州', '陵水黎族自治县', '喀什地区', '大兴安岭地区', '银川', '屯昌', '克孜勒苏柯尔克孜自治州', '儋州', '塔城地区', '那曲地区', '黄山', '玉树藏族自治州', '昆玉', '石河子', '林芝地区', '铜仁地区', '七台河', '吐鲁番地区', '琼中黎族苗族自治县', '博尔塔拉蒙古自治州', '毕节地区', '伊犁哈萨克自治州', '澄迈', '五指山', '乐东黎族自治县', '嘉峪关', '铁门关', '新疆维吾尔自治区', '哈密地区', '浙江', '怒江傈僳族自治州', '和田地区', '巴音郭楞蒙古自治州']

# 多重边无向图
# coding=utf-8
# 多重边无向图
# 自然连通度


# 根据路径画图
def drawpicture(filePath):
    """
    输入文件路径最后绘制成图G
    """
    G = nx.Graph()
    try:
        dataMiga = pd.read_csv(filePath)
    except Exception as problem:
        print("error根据路径画图出现问题：", problem)
    # 得到每一行的数据
    for row in dataMiga.itertuples():
        city_name = getattr(row, "city_name")
        city_id_name = getattr(row, "city_id_name")
        G.add_edges_from([(city_name, city_id_name)])
    return G


# 获取时间列表
def getdaylist(begin, end):
    """
    获取时间列表
    """
    beginDate = datetime.datetime.strptime(str(begin), "%Y%m%d")
    endDate = datetime.datetime.strptime(str(end), "%Y%m%d")
    dayList = []
    while beginDate <= endDate:
        dayList.append(datetime.datetime.strftime(beginDate, "%Y%m%d"))
        beginDate += datetime.timedelta(days=+1)
    return dayList


# 计算自然连通性
def naturecconnectivity(allFilePath, begindata, enddata):
    """
    返回绘制图表的
    X轴：日期
    Y轴：自然连通度数值
    """

    # 时间列表

    listData20_21 = getdaylist(begindata, enddata)
    listAlgebraicConnectivity = []
    listXdata = []
    for i in range(len(listData20_21)):
        # 循环画图
        try:
            filePathInMethon = allFilePath + listData20_21[i] + "physical.csv"
            print(filePathInMethon)
            G = drawpicture(filePathInMethon)
            G.remove_nodes_from(listDelCtiyName)
        except Exception as problem:
            print("(自然连通度) error打开迁徙文件出问题：", problem)
        else:
            # 生成邻接矩阵 直接转为稠密矩阵
            Gadjacency = np.array(nx.adjacency_matrix(G).todense())
            # 求特征值和特征向量
            eigenvalue, featurevector = np.linalg.eig(Gadjacency)
            # 取到所有点
            nodes = len(G.nodes())
            # 定义分子
            molecular = 0
            for eigenvalueNeed in eigenvalue:
                # 开始求自然连通度 ln()里的分子
                molecular = molecular + e ** eigenvalueNeed
            # 自然连通度的值
            algebraicConnectivityValue = log(molecular/nodes, e)
            # 作为Y轴
            listAlgebraicConnectivity.append(algebraicConnectivityValue)
            listXdata.append(listData20_21[i])
    print("(自然连通度)X轴数值： ", listXdata)
    print("(自然连通度)Y轴数值： ", listAlgebraicConnectivity)

    # 画图 设置X轴显示效果
    fig = plt.figure()
    ax = fig.add_subplot(111)
    # 为了设置x轴时间的显示
    def format_fn(tick_val, tick_pos):
        if int(tick_val) in range(len(listXdata)):
            return listXdata[int(tick_val)]
        else:
            return ''

    ax.xaxis.set_major_formatter(FuncFormatter(format_fn))
    ax.xaxis.set_major_locator(MaxNLocator(integer=True))

    # plt.ylim((-5, 40))
    # 横坐标每个值旋转90度
    # plt.xticks(rotation=90)
    # 设置Mac上的字体
    font = FontProperties(fname='/Library/Fonts/Arial Unicode.ttf')
    # 坐标轴ticks的字体大小
    plt.tick_params(labelsize=5)
    plt.xlabel('日期', FontProperties=font)
    plt.ylabel('自然连通行数值', FontProperties=font)
    plt.title('百度迁徙2020-2021自然连通性折线图', FontProperties=font)
    ax.plot(listXdata, listAlgebraicConnectivity)
    plt.show()

# 直接调用函数画图
naturecconnectivity("/Users/wuhao/百度迁徙数据爬取/物理联通指标所需数据/", 20200101, 20211028)

# (自然连通度)X轴数值：  ['20200101', '20200102', '20200103', '20200104', '20200105', '20200106', '20200107', '20200108', '20200109', '20200110', '20200111', '20200112', '20200113', '20200114', '20200115', '20200116', '20200117', '20200118', '20200119', '20200120', '20200121', '20200122', '20200123', '20200124', '20200125', '20200126', '20200127', '20200128', '20200129', '20200130', '20200131', '20200201', '20200202', '20200203', '20200204', '20200205', '20200206', '20200207', '20200208', '20200209', '20200301', '20200302', '20200303', '20200304', '20200305', '20200306', '20200307', '20200308', '20200309', '20200310', '20200311', '20200312', '20200313', '20200314', '20200315', '20200316', '20200317', '20200318', '20200319', '20200320', '20200321', '20200322', '20200323', '20200324', '20200325', '20200326', '20200327', '20200328', '20200329', '20200330', '20200331', '20200401', '20200402', '20200403', '20200404', '20200405', '20200406', '20200407', '20200408', '20200409', '20200410', '20200411', '20200412', '20200413', '20200414', '20200415', '20200416', '20200417', '20200418', '20200419', '20200420', '20200421', '20200422', '20200423', '20200424', '20200425', '20200426', '20200427', '20200428', '20200429', '20200430', '20200501', '20200502', '20200503', '20201001', '20201002', '20201003', '20201004', '20201005', '20201006', '20201007', '20201008', '20201009', '20201010', '20201011', '20201012', '20201013', '20201014', '20201015', '20201016', '20201017', '20201018', '20201019', '20201020', '20201021', '20201022', '20201023', '20201024', '20201025', '20201026', '20201027', '20201028', '20201029', '20201030', '20201031', '20201101', '20201102', '20201103', '20201104', '20201105', '20201106', '20201107', '20201108', '20201109', '20201110', '20201111', '20201112', '20201113', '20201114', '20201115', '20201116', '20201117', '20201118', '20201119', '20201120', '20201121', '20201122', '20201123', '20201124', '20201125', '20201126', '20201127', '20201128', '20201129', '20201130', '20201201', '20201202', '20201203', '20201204', '20201205', '20201206', '20201207', '20201208', '20201209', '20201210', '20201211', '20201212', '20201213', '20201214', '20201215', '20201216', '20201217', '20201218', '20201219', '20201220', '20201221', '20201222', '20201223', '20201224', '20201225', '20201226', '20201227', '20201228', '20201229', '20201230', '20201231', '20210101', '20210102', '20210103', '20210104', '20210105', '20210106', '20210107', '20210108', '20210109', '20210110', '20210111', '20210112', '20210113', '20210114', '20210115', '20210116', '20210117', '20210118', '20210119', '20210120', '20210121', '20210122', '20210123', '20210124', '20210125', '20210126', '20210127', '20210128', '20210129', '20210130', '20210131', '20210201', '20210202', '20210203', '20210204', '20210205', '20210206', '20210207', '20210208', '20210209', '20210210', '20210211', '20210212', '20210213', '20210214', '20210215', '20210216', '20210217', '20210218', '20210219', '20210220', '20210221', '20210222', '20210223', '20210224', '20210225', '20210226', '20210227', '20210228', '20210301', '20210302', '20210303', '20210304', '20210305', '20210306', '20210307', '20210308', '20210309', '20210310', '20210311', '20210312', '20210313', '20210314', '20210315', '20210316', '20210317', '20210318', '20210319', '20210320', '20210321', '20210322', '20210323', '20210324', '20210325', '20210326', '20210327', '20210328', '20210329', '20210330', '20210401', '20210402', '20210403', '20210404', '20210405', '20210406', '20210407', '20210408', '20210409', '20210410', '20210411', '20210412', '20210413', '20210414', '20210415', '20210416', '20210417', '20210418', '20210419', '20210420', '20210421', '20210422', '20210423', '20210424', '20210425', '20210426', '20210427', '20210428', '20210429', '20210430', '20210501', '20210502', '20210503', '20210504', '20210505', '20210506', '20210507', '20210508', '20210509', '20210510', '20210511', '20210512', '20210513', '20210514', '20210515', '20210516', '20210517', '20210518', '20210519', '20210520', '20210521', '20210522', '20210523', '20210524', '20210525', '20210526', '20210527', '20210528', '20210529', '20210530', '20210531', '20210601', '20210602', '20210603', '20210604', '20210605', '20210606', '20210607', '20210608', '20210609', '20210610', '20210611', '20210612', '20210613', '20210614', '20210615', '20210616', '20210617', '20210618', '20210619', '20210620', '20210621', '20210622', '20210623', '20210624', '20210625', '20210626', '20210627', '20210628', '20210629', '20210630', '20210701', '20210702', '20210703', '20210704', '20210705', '20210706', '20210707', '20210708', '20210709', '20210710', '20210711', '20210712', '20210713', '20210714', '20210715', '20210716', '20210717', '20210718', '20210719', '20210720', '20210721', '20210722', '20210723', '20210724', '20210725', '20210726', '20210727', '20210728', '20210729', '20210730', '20210731', '20210801', '20210802', '20210803', '20210804', '20210805', '20210806', '20210807', '20210808', '20210809', '20210810', '20210811', '20210812', '20210813', '20210814', '20210815', '20210816', '20210817', '20210818', '20210819', '20210820', '20210821', '20210822', '20210823', '20210824', '20210825', '20210826', '20210827', '20210828', '20210829', '20210830', '20210901', '20210902', '20210903', '20210904', '20210905', '20210906', '20210907', '20210908', '20210909', '20210910', '20210911', '20210912', '20210913', '20210914', '20210915', '20210916', '20210917', '20210918', '20210919', '20210920', '20210921', '20210922', '20210923', '20210924', '20210925', '20210926', '20210927', '20210928', '20210929', '20210930', '20211001', '20211002', '20211003', '20211004', '20211005', '20211006', '20211007', '20211008', '20211009', '20211010', '20211011', '20211012', '20211013', '20211014', '20211015', '20211016', '20211017', '20211018', '20211019', '20211020', '20211021', '20211022', '20211023', '20211024', '20211025', '20211026', '20211027', '20211028']

# (自然连通度)Y轴数值：  [4.651011103347004, 6.205406675404166, 8.353704031160438, 9.053717526478794, 8.80761942108889, 9.237317891914836, 9.592888014626421, 11.310777560703396, 14.332041769844786, 10.433238584696381, 12.37256142143176, 12.723195284780722, 12.800795139168663, 13.584660534478692, 15.29908456182149, 16.365091415086617, 17.75413262337409, 18.913559497454234, 19.006107423828944, 19.439985863969614, 20.86605912825746, 18.167102243359555, 16.235326557030657, 12.823254710910073, 7.171263018209744, 6.038894175197113, 7.493994385107979, 7.554506974830257, 6.926090695721258, 6.544219904697512, 5.332282211384464, 3.906235124300129, 4.544409894330391, 3.7729960299531005, 2.1619371126953237, 2.3416556010133034, 3.083108557692209, 4.183100088767754, 6.0531275267722195, 7.233403541851245, 7.6024946677161696, 8.04321614842975, 6.318104041490507, 5.742183144413331, 5.45206906298141, 5.81484274981799, 5.037549659713799, 4.342229922304359, 5.184957665740298, 5.60788274172411, 4.1404521776149235, 4.406441912858015, 4.630001380500429, 4.780290242976628, 4.7028371187135525, 5.197852513262133, 4.277445451187635, 4.13734701871615, 3.8896684532400716, 4.1285314624237275, 4.739137306753334, 4.32704790754519, 5.5168773532177715, 4.003570375060244, 3.866992574490905, 4.074248773530216, 4.235295499185886, 5.114990072005748, 4.736674409410394, 5.20333824614687, 4.263200103306019, 5.086675336308129, 6.852825162816104, 8.976949717332719, 9.659344911041373, 6.945698240023594, 8.76100387854399, 8.585443962935388, 6.49618753434008, 5.45729442596441, 5.08332661605791, 4.482405370924173, 4.29916684264091, 5.07470295698085, 4.406412159844688, 4.3004339675254775, 4.231294181129108, 4.419893339432268, 4.616330269166596, 4.743390077222526, 4.922582698379205, 4.358009772067089, 4.068774564417107, 3.391237833194504, 4.316913766274298, 4.687356413674003, 3.95630818174561, 4.300976446670074, 4.999559936741021, 5.525799566275087, 7.685663014668718, 12.79365082398616, 9.353298836581802, 7.778563001045543, 17.563556586964165, 15.938030805317899, 12.703892824277949, 11.074143743542091, 13.157686337978337, 14.809962539793448, 13.760493474138705, 13.486554984988963, 11.490395018729451, 8.279439413554401, 7.671367514636691, 7.475399860855785, 6.126681471038844, 5.404294971825655, 4.868758999993665, 5.928898081637772, 6.431588676395267, 5.179785301031994, 6.525048322561699, 5.522563342221821, 5.384393653897447, 5.36550394123125, 5.791427019098218, 6.832385457844644, 5.354582366210614, 6.511479531012844, 5.474054087555382, 5.293536265007928, 4.546072327088567, 6.126071942318405, 6.602459073071407, 5.307027844747791, 5.8626047324344945, 4.815797815567361, 5.538328002646436, 5.103517551664878, 5.617386621211286, 6.764679134998724, 4.582340630456077, 6.56697233446134, 5.201066395545203, 4.7744554843007805, 4.679681778145111, 4.746514239371901, 5.830557983546467, 4.483312253092696, 5.35947432045436, 5.504311783060688, 4.730189094272941, 4.792318881538151, 4.459473192821947, 5.8776030092768385, 4.367484936273319, 5.298499761022132, 5.034240357889216, 3.5843556723442918, 3.905898322051437, 4.366346571638208, 5.264591446837748, 3.9953386069001504, 4.76345316061451, 4.189297183175163, 4.014541864895521, 3.7374462432357562, 3.976801154347441, 5.219975950040866, 4.099468119099242, 5.163628238606254, 4.017203793322625, 3.883565414957185, 3.8966271452255468, 4.225797469723049, 5.395755675053062, 4.241765141161806, 4.918302677035733, 4.168035151667692, 3.967388673464976, 3.846212294683917, 4.516199482654707, 5.621104914021739, 4.882552012858656, 5.1128023273112895, 4.707817779471367, 4.409459642190336, 4.477940723945265, 3.9681552134660456, 4.965009520345437, 3.9400481908672336, 5.3010792917847045, 4.411041495395095, 4.598214247429166, 6.445039442752018, 8.383619743155169, 4.946519669915352, 6.150942782985613, 7.171838949190362, 2.59098133665153, 2.3021538509991872, 2.7474636804128023, 4.275988628551917, 4.575626228319087, 3.609378504113794, 4.492224148805243, 4.272582955939791, 4.640732268231621, 4.768409939813959, 5.830800155287119, 6.638670927807642, 5.706413695712945, 5.679526294305039, 5.398869509733424, 5.5186404355979715, 6.164399074873289, 6.536899394992175, 7.278019451947062, 6.8662419370552445, 7.368183979196233, 8.946604723401288, 11.923629549783888, 8.966319845765936, 4.195842118504198, 4.895652209102426, 4.855568483218433, 8.511442933318287, 8.358426075761592, 8.499564611104852, 9.248964614690655, 9.74839234768741, 10.930244871550086, 11.077831969597868, 10.340638687931966, 9.790613550817985, 8.772895161410341, 8.14115514292742, 4.501235849607686, 6.076761201089927, 5.701673440363445, 7.32898536729869, 9.638589638862744, 12.739107746068148, 14.302313741057405, 13.287862607748691, 13.763576279618606, 13.673179726640411, 13.336314897985822, 10.321973444320351, 9.61654030057835, 7.929801695393964, 5.943149938293914, 8.727243861339849, 13.041627327109628, 11.552023450085812, 10.23491656005572, 9.258929040226553, 7.864314304860995, 6.964635677486998, 7.183088172007313, 5.6485974074418905, 6.483126824073251, 5.361640060417905, 5.393143866611563, 5.001393057825181, 5.17750751438012, 6.6602525379050865, 5.298806874716987, 6.245006857508738, 5.326678621178259, 5.454294031258373, 5.339805662485444, 5.794601623485769, 7.083986867169982, 5.33349000017264, 6.5551309560987745, 5.589470074174413, 5.3064778779545385, 5.53104155719173, 6.276085386369175, 7.686991745377436, 6.055365759541324, 6.921464021191575, 5.883003974998447, 7.5689556086065135, 10.20148636686586, 14.672894653872309, 11.297390460150446, 10.801728122858353, 12.893598997248166, 10.372034620672165, 8.170953966687973, 6.698029104420319, 6.787156339776005, 5.542800419157564, 6.470109214931737, 5.887858981822275, 6.648418474767766, 6.486915521259604, 6.696440095211751, 8.138456917144852, 6.33713242425136, 7.244517045045607, 6.337875403056405, 6.105408819797912, 6.144718630636832, 6.3728930461136395, 6.610955825464948, 6.050866672495196, 6.40940080523906, 6.042922321794687, 6.529524302831964, 8.883670280996638, 12.735533944675362, 19.03969139953192, 16.389526619751884, 11.684910890311961, 11.827002409176641, 16.292105098547676, 14.20193131295687, 9.589573070276588, 7.852553880985895, 7.208623858579964, 7.464962480200714, 6.435035975579163, 5.96449491706227, 6.152239299873777, 6.1124373546452135, 7.362444696208277, 5.924158296743486, 6.649955181188094, 5.8152870642374594, 5.790137158743862, 6.050699406410413, 6.221188754948725, 7.337716124331519, 5.766147542711434, 6.659888683694398, 5.831153167373417, 5.465987801230882, 5.320771232178369, 6.1782058300180385, 7.1358304600102, 5.467676628515251, 6.340498393866572, 5.392136401987998, 6.587601136216986, 5.765661913918391, 6.1439567346426776, 7.3184204218400195, 6.227692753137334, 6.798525055181392, 5.897196748402846, 5.718117582926386, 6.090269217418917, 6.900100859625644, 11.166421946225395, 8.965572551056615, 7.307963716241134, 9.473089280397769, 9.268811778957637, 7.060676063510696, 6.896608872134629, 6.974360540256398, 5.831868218223392, 7.045667629084612, 5.912401887525932, 5.624438108437665, 5.737380428688811, 6.499453808311876, 7.527894732235636, 6.3498739374074225, 7.048075187075202, 6.576385761363496, 7.0248394381964765, 7.799935529132879, 8.009780517291519, 8.748558971119834, 7.872582319466368, 7.571563020818064, 7.2630491892515865, 7.746468507802001, 19.62669318756101, 8.869050978078498, 9.200229520287769, 7.936669638452664, 8.92254263483525, 7.695265307798327, 7.594621490091567, 7.659680251924662, 7.91950384318771, 9.1971643185237, 7.84410363561585, 8.693395654672821, 7.653963009277678, 6.877515713285091, 6.739143977953883, 6.886904483931904, 8.11884478344012, 5.985343765841077, 6.246573609079337, 5.5178372722027325, 6.687262019140849, 5.793943043993054, 5.887426096888043, 21.188073094920593, 6.5833461649865015, 6.357030195232921, 5.151011298000581, 4.478584055199196, 4.038178388218288, 4.031037257133578, 4.77685874925322, 4.287854191510129, 4.48050879601135, 4.1730715805967025, 4.317911792692897, 15.653781344320498, 4.926725300935354, 6.068829352363678, 5.209658875007854, 6.011782535526212, 4.568886880277025, 4.264065738132332, 4.135088343413393, 5.005026655537783, 5.506536823447278, 3.9372178945089376, 5.660091489810804, 4.731618174924839, 16.528629011284167, 4.317222852580342, 4.868180686218573, 5.947047796449325, 5.0941793286046035, 5.608991017507784, 5.111851811604075, 5.025311492500556, 5.418345303983189, 6.216802770056589, 5.328344690131395, 5.917691768477687, 4.986076650767602, 4.899898297788077, 4.849109863024629, 5.344673810936583, 6.131023109145218, 4.972131645773657, 5.606031309406204, 4.624044607234102, 6.302261619596667, 6.442198917979645, 6.922867890138811, 8.776637153163808, 11.224652296709218, 9.650497779030994, 7.649939042134872, 10.557646912772906, 9.950582059318114, 7.910286246190511, 6.61049290998403, 6.14657275173661, 6.948545574151099, 7.891976575639024, 9.884022228647785, 22.0287458105383, 20.995896266203488, 16.40734953054831, 12.729542850390457, 12.435458572815094, 13.459160649660717, 15.19511740328516, 15.965947946568592, 13.192674411947625, 9.276637980333268, 8.344391875074363, 8.30653892035649, 7.290006135620163, 6.591841031685058, 6.627453144586145, 7.1045635285360715, 7.666840556134024, 6.658887302635457, 7.759518003443547, 6.423705170651256, 6.297250810026696, 6.160213349047864, 6.766660793438052, 7.616669726296158, 6.462581781373212, 7.282806668960839, 6.010204775505602, 5.516814883644935, 5.236362350918701]

